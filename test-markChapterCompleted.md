# markChapterCompleted 功能测试

## 功能说明

`markChapterCompleted` 函数用于标记章节完成，只有满足以下条件才能成功标记：

1. 该章节的所有步骤都已完成
2. 用户主动调用此函数
3. 章节状态从未完成变为已完成

## 测试步骤

### 1. 基本功能测试

#### 测试环境准备

```bash
# 确保项目正常运行
pnpm dev

# 访问测试页面
http://localhost:5173/#/step/python/python-basics
```

#### 预期初始状态

- 页面显示课程目录结构
- 所有章节进度为 0%
- 总体进度为 0%
- "结束该章"按钮不可用

### 2. 步骤完成测试

#### 测试步骤1：完成第一个步骤

1. 点击第一章的第一个步骤
2. 进入学习内容页面
3. 点击"下一步"按钮
4. 返回目录，检查步骤状态

#### 预期结果

- 第一个步骤显示为已完成（绿色勾号）
- 第一章进度条更新（33% - 1/3步骤完成）
- "结束该章"按钮仍不可用

#### 测试步骤2：完成所有步骤

1. 继续完成第一章的所有步骤
2. 每次完成后返回目录查看状态
3. 完成最后一个步骤后检查

#### 预期结果

- 所有步骤都显示为已完成
- 第一章进度条显示 100%
- "结束该章"按钮变为可用状态

### 3. 章节完成测试

#### 测试步骤：标记章节完成

1. 确保第一章所有步骤都已完成
2. 点击"结束该章"按钮
3. 观察页面状态变化

#### 预期结果

- 第一章状态变为已完成（绿色边框和背景）
- 总体进度更新为 33% (1/3章节完成)
- 第二章变为可访问状态
- 控制台显示："第1章已完成"

### 4. 错误处理测试

#### 测试场景1：重复标记

1. 再次点击"结束第1章"按钮
2. 观察控制台输出

#### 预期结果

- 控制台显示章节已完成
- 状态保持不变
- 返回 true

#### 测试场景2：步骤未完成

1. 直接跳到第二章
2. 完成部分步骤（不完成所有）
3. 尝试点击"结束该章"

#### 预期结果

- 控制台显示章节未完成信息
- 返回 false
- 章节状态不变

### 5. 进度计算验证

#### 测试场景：多章节进度

1. 完成第一章 → 点击"结束该章" → 进度：33%
2. 完成第二章所有步骤 → 点击"结束该章" → 进度：67%
3. 完成第三章所有步骤 → 点击"结束该章" → 进度：100%

#### 预期结果

- 进度计算正确：基于完成的章节数
- 每完成一章，进度条更新
- 总体进度 = (已完成章节数 / 总章节数) × 100%

## 调试信息

### 1. 控制台日志

函数执行时会输出以下信息：

```javascript
// 章节完成成功
"章节 1 已完成，总体进度: 33%";

// 章节未完成
"章节 2 未完成，已完成步骤: 2/4";
```

### 2. 浏览器开发者工具

```javascript
// 查看学习状态
localStorage.getItem("learning_status");

// 查看当前状态
console.log({
  courseId: props.stepId,
  currentChapter: currentChapterId.value,
  currentStep: currentStepId.value,
  expandedChapters: expandedChapters.value,
});
```

### 3. Vue DevTools

- 检查组件状态
- 查看响应式数据变化
- 监控函数调用

## 常见问题排查

### 问题1：章节无法标记完成

**可能原因：**

- 步骤未全部完成
- 函数参数错误
- 状态数据损坏

**排查步骤：**

1. 检查控制台日志
2. 验证步骤完成状态
3. 检查函数参数
4. 查看 localStorage 数据

### 问题2：进度计算错误

**可能原因：**

- 进度计算逻辑错误
- 数据状态不一致
- 缓存问题

**排查步骤：**

1. 检查 `markChapterCompleted` 函数
2. 验证进度计算公式
3. 清除 localStorage 重新测试
4. 检查课程数据结构

### 问题3：UI状态不更新

**可能原因：**

- 响应式数据未更新
- 计算属性依赖错误
- 组件未重新渲染

**排查步骤：**

1. 检查 Vue 响应式系统
2. 验证计算属性依赖
3. 强制组件重新渲染
4. 检查事件绑定

## 测试用例

### 用例1：正常流程

```javascript
// 输入：完成第一章所有步骤
// 操作：点击"结束该章"
// 预期：章节完成，进度更新为33%
```

### 用例2：异常流程

```javascript
// 输入：步骤未全部完成
// 操作：点击"结束该章"
// 预期：操作失败，状态不变
```

### 用例3：边界情况

```javascript
// 输入：最后一章完成
// 操作：点击"结束该章"
// 预期：课程完成，进度100%
```

## 总结

`markChapterCompleted` 函数是章节完成系统的核心，它：

1. ✅ **验证完成条件**：确保所有步骤都已完成
2. ✅ **更新章节状态**：标记章节为已完成
3. ✅ **计算总体进度**：基于完成的章节数
4. ✅ **持久化状态**：保存到 localStorage
5. ✅ **提供反馈**：返回操作结果

测试时重点关注：

- 步骤完成状态的准确性
- 章节完成条件的验证
- 进度计算的正确性
- 状态持久化的可靠性
- 错误处理的完整性
